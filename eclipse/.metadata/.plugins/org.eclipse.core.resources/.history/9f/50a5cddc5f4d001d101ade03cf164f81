package fr.skhr.loyto.UnderUtilities.client;

import java.io.File;
import java.util.UUID;

import org.lwjgl.opengl.GL11;

import com.mojang.authlib.GameProfile;

import cpw.mods.fml.common.eventhandler.Event;
import fr.skhr.loyto.UnderUtilities.proxy.ClientProxy;
import net.minecraft.block.Block;
import net.minecraft.client.Minecraft;
import net.minecraft.client.entity.AbstractClientPlayer;
import net.minecraft.client.renderer.IImageBuffer;
import net.minecraft.client.renderer.ImageBufferDownload;
import net.minecraft.client.renderer.RenderBlocks;
import net.minecraft.client.renderer.ThreadDownloadImageData;
import net.minecraft.client.renderer.entity.RenderManager;
import net.minecraft.client.renderer.entity.RenderPlayer;
import net.minecraft.client.renderer.texture.ITextureObject;
import net.minecraft.client.renderer.texture.TextureManager;
import net.minecraft.client.renderer.tileentity.TileEntitySkullRenderer;
import net.minecraft.entity.Entity;
import net.minecraft.entity.EntityLivingBase;
import net.minecraft.entity.player.EntityPlayer;
import net.minecraft.init.Items;
import net.minecraft.item.EnumAction;
import net.minecraft.item.ItemStack;
import net.minecraft.nbt.NBTTagCompound;
import net.minecraft.nbt.NBTUtil;
import net.minecraft.util.MathHelper;
import net.minecraft.util.ResourceLocation;
import net.minecraft.util.StringUtils;
import net.minecraftforge.client.IItemRenderer;
import net.minecraftforge.client.MinecraftForgeClient;
import net.minecraftforge.client.event.RenderPlayerEvent;
import net.minecraftforge.common.MinecraftForge;

public class underPlayerRender extends RenderPlayer {
	   private static final ResourceLocation defaultSkin = new ResourceLocation("textures/entity/steve.png");
	  private ResourceLocation locationSkin;
	  
	  public underPlayerRender() {
	     func_76976_a(RenderManager.field_78727_a);
	  }
	  
	  protected ResourceLocation func_110775_a(AbstractClientPlayer player) {
	     getResourceLocationSkinAndCape(player.func_70005_c_());
	     downloadPlayerSkin(getLocationSkin(), player.func_70005_c_());
	     return getLocationSkin();
	  }
	  
	  protected ResourceLocation func_110775_a(Entity entity) {
	     return func_110775_a((AbstractClientPlayer)entity);
	  }

	  
	  public void func_82441_a(EntityPlayer player) {
	     ClientProxy.bindTexture(func_110775_a((Entity)player));
	     super.func_82441_a(player);
	  }
	  
	  protected void func_77029_c(AbstractClientPlayer player, float p_77029_2_) {
	     RenderPlayerEvent.Specials.Pre event = new RenderPlayerEvent.Specials.Pre((EntityPlayer)player, this, p_77029_2_);
	     if (MinecraftForge.EVENT_BUS.post((Event)event))
	      return; 
	    GL11.glColor3f(1.0F, 1.0F, 1.0F);
	    super.func_77029_c(player, p_77029_2_);
	    func_85093_e((EntityLivingBase)player, p_77029_2_);
	    ItemStack itemstack = player.field_71071_by.func_70440_f(3);
	    
	    if (itemstack != null && event.renderHelmet) {
	      GL11.glPushMatrix();
	      this.field_77109_a.field_78116_c.func_78794_c(0.0625F);

	      
	      if (itemstack.func_77973_b() instanceof net.minecraft.item.ItemBlock) {
	        IItemRenderer customRenderer = MinecraftForgeClient.getItemRenderer(itemstack, IItemRenderer.ItemRenderType.EQUIPPED);
	        boolean is3D = (customRenderer != null && customRenderer.shouldUseRenderHelper(IItemRenderer.ItemRenderType.EQUIPPED, itemstack, IItemRenderer.ItemRendererHelper.BLOCK_3D));
	        
	        if (is3D || RenderBlocks.func_147739_a(Block.func_149634_a(itemstack.func_77973_b()).func_149645_b())) {
	          float f1 = 0.625F;
	          GL11.glTranslatef(0.0F, -0.25F, 0.0F);
	          GL11.glRotatef(90.0F, 0.0F, 1.0F, 0.0F);
	          GL11.glScalef(f1, -f1, -f1);
	        } 
	        
	        this.field_76990_c.field_78721_f.func_78443_a((EntityLivingBase)player, itemstack, 0);
	        } else if (itemstack.func_77973_b() == Items.field_151144_bL) {
	        float f1 = 1.0625F;
	        GL11.glScalef(f1, -f1, -f1);
	        GameProfile gameprofile = null;
	        
	        if (itemstack.func_77942_o()) {
	          NBTTagCompound nbttagcompound = itemstack.func_77978_p();
	          
	          if (nbttagcompound.func_150297_b("SkullOwner", 10)) {
	            gameprofile = NBTUtil.func_152459_a(nbttagcompound.func_74775_l("SkullOwner"));
	          } else if (nbttagcompound.func_150297_b("SkullOwner", 8) && !StringUtils.func_151246_b(nbttagcompound.func_74779_i("SkullOwner"))) {
	            gameprofile = new GameProfile((UUID)null, nbttagcompound.func_74779_i("SkullOwner"));
	          } 
	        } 
	        
	        TileEntitySkullRenderer.field_147536_b.func_152674_a(-0.5F, 0.0F, -0.5F, 1, 180.0F, itemstack.func_77960_j(), gameprofile);
	      } 
	      
	      GL11.glPopMatrix();
	    } 

	    
	    if (player.func_70005_c_().equals("deadmaus") && hasSkin()) {
	      func_110776_a(getLocationSkin());
	      
	      for (int j = 0; j < 2; j++) {
	        float f9 = player.field_70126_B + (player.field_70177_z - player.field_70126_B) * p_77029_2_ - player.field_70760_ar + (player.field_70761_aq - player.field_70760_ar) * p_77029_2_;
	        float f10 = player.field_70127_C + (player.field_70125_A - player.field_70127_C) * p_77029_2_;
	        GL11.glPushMatrix();
	        GL11.glRotatef(f9, 0.0F, 1.0F, 0.0F);
	        GL11.glRotatef(f10, 1.0F, 0.0F, 0.0F);
	        GL11.glTranslatef(0.375F * (j * 2 - 1), 0.0F, 0.0F);
	        GL11.glTranslatef(0.0F, -0.375F, 0.0F);
	        GL11.glRotatef(-f10, 1.0F, 0.0F, 0.0F);
	        GL11.glRotatef(-f9, 0.0F, 1.0F, 0.0F);
	        float f2 = 1.3333334F;
	        GL11.glScalef(f2, f2, f2);
	        this.field_77109_a.func_78110_b(0.0625F);
	        GL11.glPopMatrix();
	      } 
	    } 
	    
	    boolean flag = false;
	    flag = (event.renderCape && flag);

	    
	    if (flag && !player.func_82150_aj() && !player.func_82238_cc()) {
	      func_110776_a(player.func_110303_q());
	      GL11.glPushMatrix();
	      GL11.glTranslatef(0.0F, 0.0F, 0.125F);
	      double d3 = player.field_71091_bM + (player.field_71094_bP - player.field_71091_bM) * p_77029_2_ - player.field_70169_q + (player.field_70165_t - player.field_70169_q) * p_77029_2_;

	      
	      double d4 = player.field_71096_bN + (player.field_71095_bQ - player.field_71096_bN) * p_77029_2_ - player.field_70167_r + (player.field_70163_u - player.field_70167_r) * p_77029_2_;

	      
	      double d0 = player.field_71097_bO + (player.field_71085_bR - player.field_71097_bO) * p_77029_2_ - player.field_70166_s + (player.field_70161_v - player.field_70166_s) * p_77029_2_;

	      
	      float f4 = player.field_70760_ar + (player.field_70761_aq - player.field_70760_ar) * p_77029_2_;
	      
	      double d1 = MathHelper.func_76126_a(f4 * 3.1415927F / 180.0F);
	      float f5 = (float)d4 * 10.0F;
	      
	        f5 = -6.0F;
	      }
	      
	      if (f5 > 32.0F) {
	        f5 = 32.0F;
	      }
	      
	      float f6 = (float)(d3 * d1 + d0 * d2) * 100.0F;
	      float f7 = (float)(d3 * d2 - d0 * d1) * 100.0F;
	      
	      if (f6 < 0.0F) {
	        f6 = 0.0F;
	      }
	      
	      float f8 = player.field_71107_bF + (player.field_71109_bG - player.field_71107_bF) * p_77029_2_;
	      f5 += MathHelper.func_76126_a((player.field_70141_P + (player.field_70140_Q - player.field_70141_P) * p_77029_2_) * 6.0F) * 32.0F * f8;

	      
	      if (player.func_70093_af()) {
	        f5 += 25.0F;
	      }
	      
	      GL11.glRotatef(6.0F + f6 / 2.0F + f5, 1.0F, 0.0F, 0.0F);
	      GL11.glRotatef(f7 / 2.0F, 0.0F, 0.0F, 1.0F);
	      GL11.glRotatef(-f7 / 2.0F, 0.0F, 1.0F, 0.0F);
	      GL11.glRotatef(180.0F, 0.0F, 1.0F, 0.0F);
	      this.field_77109_a.func_78111_c(0.0625F);
	      GL11.glPopMatrix();
	    } 
	    
	    ItemStack itemstack1 = player.field_71071_by.func_70448_g();
	    
	    if (itemstack1 != null && event.renderItem) {
	      GL11.glPushMatrix();
	      this.field_77109_a.field_78112_f.func_78794_c(0.0625F);
	      GL11.glTranslatef(-0.0625F, 0.4375F, 0.0625F);
	      
	      if (player.field_71104_cf != null) {
	        itemstack1 = new ItemStack(Items.field_151055_y);
	      }
	      
	      EnumAction enumaction = null;
	      
	      if (player.func_71052_bv() > 0) {
	        enumaction = itemstack1.func_77975_n();
	      }
	      
	      IItemRenderer customRenderer = MinecraftForgeClient.getItemRenderer(itemstack1, IItemRenderer.ItemRenderType.EQUIPPED);
	      boolean is3D = (customRenderer != null && customRenderer.shouldUseRenderHelper(IItemRenderer.ItemRenderType.EQUIPPED, itemstack1, IItemRenderer.ItemRendererHelper.BLOCK_3D));
	      
	      if (is3D || (itemstack1.func_77973_b() instanceof net.minecraft.item.ItemBlock && RenderBlocks.func_147739_a(Block.func_149634_a(itemstack1.func_77973_b()).func_149645_b()))) {
	        float f2 = 0.5F;
	        GL11.glTranslatef(0.0F, 0.1875F, -0.3125F);
	        f2 *= 0.75F;
	        GL11.glRotatef(20.0F, 1.0F, 0.0F, 0.0F);
	        GL11.glRotatef(45.0F, 0.0F, 1.0F, 0.0F);
	        GL11.glScalef(-f2, -f2, f2);
	      } else if (itemstack1.func_77973_b() == Items.field_151031_f) {
	        float f2 = 0.625F;
	        GL11.glTranslatef(0.0F, 0.125F, 0.3125F);
	        GL11.glRotatef(-20.0F, 0.0F, 1.0F, 0.0F);
	        GL11.glScalef(f2, -f2, f2);
	        GL11.glRotatef(-100.0F, 1.0F, 0.0F, 0.0F);
	        GL11.glRotatef(45.0F, 0.0F, 1.0F, 0.0F);
	      } else if (itemstack1.func_77973_b().func_77662_d()) {
	        float f2 = 0.625F;
	        
	        if (itemstack1.func_77973_b().func_77629_n_()) {
	          GL11.glRotatef(180.0F, 0.0F, 0.0F, 1.0F);
	          GL11.glTranslatef(0.0F, -0.125F, 0.0F);
	        } 
	        
	        if (player.func_71052_bv() > 0 && enumaction == EnumAction.block) {
	          GL11.glTranslatef(0.05F, 0.0F, -0.1F);
	          GL11.glRotatef(-50.0F, 0.0F, 1.0F, 0.0F);
	          GL11.glRotatef(-10.0F, 1.0F, 0.0F, 0.0F);
	          GL11.glRotatef(-60.0F, 0.0F, 0.0F, 1.0F);
	        } 
	        
	        GL11.glTranslatef(0.0F, 0.1875F, 0.0F);
	        GL11.glScalef(f2, -f2, f2);
	        GL11.glRotatef(-100.0F, 1.0F, 0.0F, 0.0F);
	        GL11.glRotatef(45.0F, 0.0F, 1.0F, 0.0F);
	      } else {
	        float f2 = 0.375F;
	        GL11.glTranslatef(0.25F, 0.1875F, -0.1875F);
	        GL11.glScalef(f2, f2, f2);
	        GL11.glRotatef(60.0F, 0.0F, 0.0F, 1.0F);
	        GL11.glRotatef(-90.0F, 1.0F, 0.0F, 0.0F);
	        GL11.glRotatef(20.0F, 0.0F, 0.0F, 1.0F);
	      } 




	      
	      if (itemstack1.func_77973_b().func_77623_v()) {
	        for (int k = 0; k < itemstack1.func_77973_b().getRenderPasses(itemstack.func_77960_j()); k++) {
	          int i = itemstack1.func_77973_b().func_82790_a(itemstack1, k);
	          float f12 = (i >> 16 & 0xFF) / 255.0F;
	          float f3 = (i >> 8 & 0xFF) / 255.0F;
	          float f4 = (i & 0xFF) / 255.0F;
	          GL11.glColor4f(f12, f3, f4, 1.0F);
	          this.field_76990_c.field_78721_f.func_78443_a((EntityLivingBase)player, itemstack1, k);
	        } 
	      } else {
	        int k = itemstack1.func_77973_b().func_82790_a(itemstack1, 0);
	        float f11 = (k >> 16 & 0xFF) / 255.0F;
	        float f12 = (k >> 8 & 0xFF) / 255.0F;
	        float f3 = (k & 0xFF) / 255.0F;
	        GL11.glColor4f(f11, f12, f3, 1.0F);
	        this.field_76990_c.field_78721_f.func_78443_a((EntityLivingBase)player, itemstack1, 0);
	      } 
	      
	      GL11.glPopMatrix();
	    } 
	    MinecraftForge.EVENT_BUS.post((Event)new RenderPlayerEvent.Specials.Post((EntityPlayer)player, this, p_77029_2_));
	  }
	  public boolean hasSkin() {
	    return (this.locationSkin != null);
	  }
	  public ResourceLocation getResourceLocationSkinAndCape(String username) {
	    return this.locationSkin = new ResourceLocation("skins/" + StringUtils.func_76338_a(username));
	  }
	  public ResourceLocation getLocationSkin() {
	    return (this.locationSkin == null) ? defaultSkin : this.locationSkin;
	  }
	  
	  public static ThreadDownloadImageData downloadPlayerSkin(ResourceLocation resourceLocationIn, String username) {
	    TextureManager texturemanager = Minecraft.func_71410_x().func_110434_K();
	    Object object = texturemanager.func_110581_b(resourceLocationIn);
	    
	    if (object == null) {
	      object = new ThreadDownloadImageData((File)null, String.format("https://www.undercraft.fr/api/skins/%s", new Object[] {
	              StringUtils.func_76338_a(username) }), defaultSkin, (IImageBuffer)new ImageBufferDownload());
	      texturemanager.func_110579_a(resourceLocationIn, (ITextureObject)object);
	      System.out.println("Skin OK ");
	    } 
	    
	    return (ThreadDownloadImageData)object;
	  }